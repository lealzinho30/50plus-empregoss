/**
 * üñºÔ∏è SISTEMA DE GERENCIAMENTO DE IMAGENS - 50+ Empregos
 * Sistema de placeholders inteligentes para troca r√°pida de imagens
 */

// Configura√ß√£o centralizada de todas as imagens do site
const IMAGE_PLACEHOLDERS = {
    'hero': {
        default: 'assets/images/hero-bg.jpg',
        alternative: 'assets/images/hero-alternative.jpg',
        description: 'Imagem de fundo da se√ß√£o principal'
    },
    'services': {
        default: 'assets/images/services-bg.jpg',
        alternative: 'assets/images/services-alternative.jpg',
        description: 'Imagem da se√ß√£o de servi√ßos'
    },
    'vagas': {
        default: 'assets/images/jobs-bg.jpg',
        alternative: 'assets/images/jobs-alternative.jpg',
        description: 'Imagem da se√ß√£o de vagas'
    },
    'cursos': {
        default: 'assets/images/training-bg.jpg',
        alternative: 'assets/images/training-alternative.jpg',
        description: 'Imagem da se√ß√£o de cursos'
    },
    'depoimentos': {
        default: 'assets/images/testimonials-bg.jpg',
        alternative: 'assets/images/testimonials-alternative.jpg',
        description: 'Imagem da se√ß√£o de depoimentos'
    },
    'cta': {
        default: 'assets/images/cta-bg.jpg',
        alternative: 'assets/images/cta-alternative.jpg',
        description: 'Imagem da se√ß√£o de call-to-action'
    },
    'empresas': {
        default: 'assets/images/companies-bg.jpg',
        alternative: 'assets/images/companies-alternative.jpg',
        description: 'Imagem da se√ß√£o de empresas'
    },
    'sobre': {
        default: 'assets/images/about-bg.jpg',
        alternative: 'assets/images/about-alternative.jpg',
        description: 'Imagem da se√ß√£o sobre'
    },
    'proposta': {
        default: 'assets/images/value-prop-bg.jpg',
        alternative: 'assets/images/value-prop-alternative.jpg',
        description: 'Imagem da se√ß√£o de proposta de valor'
    }
};

// ========== FUN√á√ïES PRINCIPAIS ==========

/**
 * üîÑ Troca imagem de uma se√ß√£o espec√≠fica
 * @param {string} section - Nome da se√ß√£o (hero, about, services, vagas)
 * @param {string} imageType - 'default' ou 'alternative' ou URL espec√≠fica
 * @param {number} alternativeIndex - √çndice da alternativa (0, 1, 2...)
 */
function changeSectionImage(section, imageType = 'default', alternativeIndex = 0) {
    if (!IMAGE_PLACEHOLDERS[section]) {
        console.error(`‚ùå Se√ß√£o "${section}" n√£o encontrada`);
        return false;
    }

    const config = IMAGE_PLACEHOLDERS[section];
    let newImageSrc = '';
    let newAlt = config.alt;

    // Determinar qual imagem usar
    if (imageType === 'default') {
        newImageSrc = config.default;
    } else if (imageType === 'alternative') {
        if (config.alternatives[alternativeIndex]) {
            newImageSrc = config.alternatives[alternativeIndex];
        } else {
            newImageSrc = config.alternatives[0]; // Fallback para primeira alternativa
        }
    } else if (imageType.startsWith('http') || imageType.startsWith('assets/') || imageType.startsWith('data:image')) {
        // URL personalizada ou imagem base64
        newImageSrc = imageType;
    } else {
        console.error(`‚ùå Tipo de imagem inv√°lido: ${imageType}`);
        return false;
    }

    // Aplicar a mudan√ßa
    return applyImageChange(section, newImageSrc, newAlt);
}

/**
 * üéØ Aplica a mudan√ßa de imagem na p√°gina
 * @param {string} section - Nome da se√ß√£o
 * @param {string} src - Nova URL da imagem (pode ser URL ou base64)
 * @param {string} alt - Novo texto alternativo
 */
function applyImageChange(section, src, alt) {
    console.log('üîç DEBUG: ==========================================');
    console.log('üîç DEBUG: applyImageChange chamado para se√ß√£o:', section);
    console.log('üîç DEBUG: src (primeiros 100 chars):', src.substring(0, 100) + '...');
    console.log('üîç DEBUG: alt:', alt);
    console.log('üîç DEBUG: Tipo de src:', typeof src);
    console.log('üîç DEBUG: Src √© v√°lido?', src && src.length > 0);

    let selectors = [];
    let success = false;

    // Mapear se√ß√£o para m√∫ltiplos seletores CSS (fallback)
    switch (section) {
        case 'hero':
            selectors = [
                '.hero-media img',
                '#hero .hero-media img',
                '.hero img',
                'section#hero img',
                'img[src*="unsplash"]' // Fallback gen√©rico
            ];
            break;
        case 'sobre':
            selectors = [
                '.about-image img',
                '.about-us img',
                '.about img',
                'section.about-us img',
                '.sobre-imagens img',
                'section.sobre-imagens img',
                'section#sobre img'
            ];
            break;
        case 'services':
            selectors = [
                '.feature-media img',
                '.feature img',
                '.services img',
                'section.feature img',
                'section.feature img'
            ];
            break;
        case 'vagas':
            // Para vagas, precisamos atualizar o JavaScript
            updateVagasImages(src);
            success = true;
            break;
        case 'cursos':
            selectors = [
                '.training img',
                'section.training img',
                'section#capacitacao img'
            ];
            break;
        case 'depoimentos':
            selectors = [
                '.testimonial img',
                '.depoimento img',
                '.avatar img',
                'section.testimonials img'
            ];
            break;
        case 'cta':
            selectors = [
                '.cta img',
                '.final-cta img',
                'section.cta-final img'
            ];
            break;
        case 'empresas':
            selectors = [
                '.for-companies img',
                'section.for-companies img',
                'section#empresas img'
            ];
            break;
        case 'sobre':
            selectors = [
                '.sobre-imagens img',
                'section.sobre-imagens img',
                'section#sobre img'
            ];
            break;
        case 'proposta':
            selectors = [
                '.value-prop img',
                'section.value-prop img',
                'section#proposta img'
            ];
            break;
        default:
            console.error(`‚ùå Se√ß√£o "${section}" n√£o encontrada`);
            return false;
    }

    // Tentar cada seletor at√© encontrar a imagem
    if (selectors.length > 0) {
        for (let selector of selectors) {
            console.log('üîç DEBUG: Tentando seletor:', selector);
            const imageElement = document.querySelector(selector);
            if (imageElement) {
                console.log('üîç DEBUG: Elemento de imagem encontrado:', imageElement);
                try {
                    // Verificar se √© uma imagem v√°lida antes de aplicar
                    if (src && (src.startsWith('http') || src.startsWith('data:image') || src.startsWith('assets/'))) {
                        console.log('üîç DEBUG: Aplicando imagem v√°lida:', src.substring(0, 50) + '...');
                        imageElement.src = src;
                        imageElement.alt = alt || `Imagem para a se√ß√£o ${section}`;
                        success = true;
                        
                        // Salvar imagem personalizada automaticamente
                        if (src.startsWith('data:image')) {
                            saveCustomImage(section, src, alt || `Imagem personalizada para ${section}`);
                        }
                        
                        console.log(`‚úÖ Imagem da se√ß√£o "${section}" alterada com sucesso usando seletor: ${selector}`);
                        break;
                    } else {
                        console.error('‚ùå URL da imagem inv√°lida:', src);
                        return false;
                    }
                } catch (error) {
                    console.error(`‚ùå Erro ao alterar imagem com seletor ${selector}:`, error);
                    continue;
                }
            }
        }
        
        if (!success) {
            console.error(`‚ùå Nenhum elemento de imagem encontrado para se√ß√£o "${section}". Seletores tentados:`, selectors);
            
            // Debug: mostrar todas as imagens na p√°gina
            const allImages = document.querySelectorAll('img');
            console.log(`üîç Total de imagens na p√°gina: ${allImages.length}`);
            allImages.forEach((img, index) => {
                console.log(`   ${index}: ${img.src} (${img.className} - ${img.parentElement.className})`);
            });
            
            // Debug adicional: mostrar estrutura da se√ß√£o
            console.log('üîç DEBUG: Estrutura da se√ß√£o:', section);
            const sectionElement = document.querySelector(`#${section}`) || document.querySelector(`.${section}`);
            if (sectionElement) {
                console.log('üîç DEBUG: Se√ß√£o encontrada:', sectionElement);
                console.log('üîç DEBUG: Imagens dentro da se√ß√£o:', sectionElement.querySelectorAll('img'));
            } else {
                console.log('üîç DEBUG: Se√ß√£o n√£o encontrada no DOM');
            }
        }
    }

    return success;
}

/**
 * üé≤ Troca para uma imagem aleat√≥ria da se√ß√£o
 * @param {string} section - Nome da se√ß√£o
 */
function randomizeSectionImage(section) {
    if (!IMAGE_PLACEHOLDERS[section]) {
        console.error(`‚ùå Se√ß√£o "${section}" n√£o encontrada`);
        return false;
    }

    const config = IMAGE_PLACEHOLDERS[section];
    const allImages = [config.default, ...config.alternatives];
    const randomIndex = Math.floor(Math.random() * allImages.length);
    const randomImage = allImages[randomIndex];

    return changeSectionImage(section, randomImage);
}

/**
 * üîÑ Atualiza todas as imagens de uma vez
 * @param {Object} imageMap - Mapa de se√ß√£o -> nova imagem
 */
function updateMultipleImages(imageMap) {
    const results = {};
    
    Object.keys(imageMap).forEach(section => {
        results[section] = changeSectionImage(section, imageMap[section]);
    });

    console.log('üìä Resultado das atualiza√ß√µes:', results);
    return results;
}

/**
 * üì± Atualiza imagens das vagas (especial para o sistema de vagas)
 * @param {string} newImageSrc - Nova URL da imagem
 */
function updateVagasImages(newImageSrc) {
    // Atualizar a configura√ß√£o das vagas
    if (typeof featuredJobs !== 'undefined') {
        featuredJobs.forEach(job => {
            if (job.image && job.image.includes('pexels.com')) {
                job.image = newImageSrc;
            }
        });
        
        // Re-renderizar as vagas se estiverem vis√≠veis
        if (typeof renderJobs === 'function') {
            renderJobs();
        }
        
        console.log('‚úÖ Imagens das vagas atualizadas!');
    }
}

/**
 * üíº Atualiza imagem de uma vaga espec√≠fica pelo t√≠tulo
 * @param {string} jobTitle - T√≠tulo da vaga
 * @param {string} newImageSrc - Nova URL da imagem
 */
function updateSpecificJobImage(jobTitle, newImageSrc) {
    if (typeof featuredJobs !== 'undefined') {
        const job = featuredJobs.find(job => 
            job.title.toLowerCase().includes(jobTitle.toLowerCase())
        );
        
        if (job) {
            job.image = newImageSrc;
            
            // Salvar no localStorage para persist√™ncia
            const customImages = JSON.parse(localStorage.getItem('customImages') || '{}');
            customImages[`vaga_${jobTitle}`] = {
                src: newImageSrc,
                alt: `Imagem personalizada da vaga ${jobTitle}`,
                timestamp: Date.now(),
                jobTitle: jobTitle
            };
            localStorage.setItem('customImages', JSON.stringify(customImages));
            
            // Re-renderizar as vagas se estiverem vis√≠veis
            if (typeof renderJobs === 'function') {
                renderJobs();
            } else {
                // Fallback: tentar re-renderizar diretamente
                console.log('üîÑ Tentando re-renderizar vagas...');
                const jobsGrid = document.getElementById('featuredJobs');
                if (jobsGrid && typeof createJobCard === 'function') {
                    // For√ßar re-render das vagas vis√≠veis
                    const visibleJobs = Array.from(jobsGrid.querySelectorAll('.job-card'));
                    visibleJobs.forEach(jobCard => {
                        const jobTitle = jobCard.querySelector('.job-title')?.textContent;
                        if (jobTitle && jobTitle.toLowerCase().includes(jobTitle.toLowerCase())) {
                            // Atualizar a imagem diretamente no DOM
                            const imageContainer = jobCard.querySelector('.job-sector-icon');
                            if (imageContainer) {
                                const existingImage = imageContainer.querySelector('img');
                                if (existingImage) {
                                    existingImage.src = newImageSrc;
                                    existingImage.alt = jobTitle;
                                    existingImage.className = 'job-custom-image';
                                    console.log(`‚úÖ Imagem atualizada diretamente no DOM para "${jobTitle}"`);
                                }
                            }
                        }
                    });
                }
            }
            
            console.log(`‚úÖ Imagem da vaga "${job.title}" atualizada e salva no localStorage!`);
            return true;
        } else {
            console.error(`‚ùå Vaga com t√≠tulo "${jobTitle}" n√£o encontrada`);
            return false;
        }
    }
    return false;
}

/**
 * üìã Lista todas as vagas dispon√≠veis para edi√ß√£o
 */
function listAvailableJobs() {
    if (typeof featuredJobs !== 'undefined') {
        console.log('üìã Vagas dispon√≠veis para edi√ß√£o de imagens:');
        featuredJobs.forEach((job, index) => {
            console.log(`\nüíº ${index + 1}. ${job.title}`);
            console.log(`   üè¢ Empresa: ${job.company}`);
            console.log(`   üìç Local: ${job.location}`);
            console.log(`   üí∞ Sal√°rio: ${job.salary}`);
            console.log(`   üñºÔ∏è Imagem atual: ${job.image ? 'Sim' : 'N√£o'}`);
        });
        
        return featuredJobs.map(job => ({
            title: job.title,
            company: job.company,
            location: job.location,
            salary: job.salary,
            hasImage: !!job.image
        }));
    } else {
        console.error('‚ùå Lista de vagas n√£o est√° dispon√≠vel');
        return [];
    }
}

// ========== FUN√á√ïES DE UTILIDADE ==========

/**
 * üìã Lista todas as se√ß√µes dispon√≠veis
 */
function listAvailableSections() {
    console.log('üìã Se√ß√µes dispon√≠veis para troca de imagens:');
    Object.keys(IMAGE_PLACEHOLDERS).forEach(section => {
        const config = IMAGE_PLACEHOLDERS[section];
        console.log(`\nüéØ ${section.toUpperCase()}:`);
        console.log(`   üì∏ Padr√£o: ${config.default}`);
        console.log(`   üîÑ Alternativas: ${config.alternatives.length}`);
        console.log(`   üìù Descri√ß√£o: ${config.description}`);
    });
}

/**
 * üîç Mostra configura√ß√£o de uma se√ß√£o espec√≠fica
 * @param {string} section - Nome da se√ß√£o
 */
function showSectionConfig(section) {
    if (!IMAGE_PLACEHOLDERS[section]) {
        console.error(`‚ùå Se√ß√£o "${section}" n√£o encontrada`);
        return;
    }

    const config = IMAGE_PLACEHOLDERS[section];
    console.log(`\nüîç Configura√ß√£o da se√ß√£o "${section}":`);
    console.log(`   üì∏ Padr√£o: ${config.default}`);
    console.log(`   üîÑ Alternativas:`);
    config.alternatives.forEach((alt, index) => {
        console.log(`      ${index}: ${alt}`);
    });
    console.log(`   üìù Alt: ${config.alt}`);
    console.log(`   üìÑ Descri√ß√£o: ${config.description}`);
}

// ========== SISTEMA DE PERSIST√äNCIA ==========

/**
 * üíæ Salva imagem personalizada no localStorage
 * @param {string} section - Nome da se√ß√£o
 * @param {string} imageSrc - URL ou base64 da imagem
 * @param {string} alt - Texto alternativo
 */
function saveCustomImage(section, imageSrc, alt) {
    try {
        const customImages = JSON.parse(localStorage.getItem('customImages') || '{}');
        customImages[section] = {
            src: imageSrc,
            alt: alt,
            timestamp: Date.now()
        };
        localStorage.setItem('customImages', JSON.stringify(customImages));
        console.log(`üíæ Imagem personalizada salva para se√ß√£o "${section}"`);
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao salvar imagem:', error);
        return false;
    }
}

/**
 * üìÇ Carrega imagens personalizadas do localStorage
 */
function loadCustomImages() {
    try {
        const customImages = JSON.parse(localStorage.getItem('customImages') || '{}');
        console.log('üìÇ Imagens personalizadas carregadas:', Object.keys(customImages));
        
        Object.keys(customImages).forEach(section => {
            const customImage = customImages[section];
            if (customImage && customImage.src) {
                if (section.startsWith('vaga_')) {
                    // √â uma imagem de vaga espec√≠fica
                    const jobTitle = customImage.jobTitle;
                    console.log(`üîÑ Aplicando imagem personalizada para vaga "${jobTitle}"`);
                    updateSpecificJobImage(jobTitle, customImage.src);
                } else {
                    // √â uma imagem de se√ß√£o normal
                    console.log(`üîÑ Aplicando imagem personalizada para "${section}"`);
                    applyImageChange(section, customImage.src, customImage.alt);
                }
            }
        });
        
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao carregar imagens personalizadas:', error);
        return false;
    }
}

/**
 * üóëÔ∏è Remove imagem personalizada de uma se√ß√£o
 * @param {string} section - Nome da se√ß√£o
 */
function removeCustomImage(section) {
    try {
        const customImages = JSON.parse(localStorage.getItem('customImages') || '{}');
        
        if (section.startsWith('vaga_')) {
            // √â uma imagem de vaga espec√≠fica
            const jobTitle = customImages[section]?.jobTitle;
            if (jobTitle) {
                // Resetar para imagem padr√£o das vagas
                if (typeof featuredJobs !== 'undefined') {
                    const job = featuredJobs.find(job => 
                        job.title.toLowerCase().includes(jobTitle.toLowerCase())
                    );
                    if (job) {
                        job.image = IMAGE_PLACEHOLDERS.vagas.default;
                        if (typeof renderJobs === 'function') {
                            renderJobs();
                        }
                    }
                }
            }
        } else {
            // √â uma imagem de se√ß√£o normal
            if (IMAGE_PLACEHOLDERS[section]) {
                const config = IMAGE_PLACEHOLDERS[section];
                applyImageChange(section, config.default, config.alt);
            }
        }
        
        delete customImages[section];
        localStorage.setItem('customImages', JSON.stringify(customImages));
        
        console.log(`üóëÔ∏è Imagem personalizada removida da se√ß√£o "${section}"`);
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao remover imagem:', error);
        return false;
    }
}

// ========== EXPORTA√á√ÉO PARA USO GLOBAL ==========

// Disponibilizar fun√ß√µes globalmente
window.ImageManager = {
    changeSectionImage,
    randomizeSectionImage,
    updateMultipleImages,
    listAvailableSections,
    showSectionConfig,
    saveCustomImage,
    loadCustomImages,
    removeCustomImage,
    updateVagasImages,
    updateSpecificJobImage,
    listAvailableJobs,
    IMAGE_PLACEHOLDERS
};

// Log de inicializa√ß√£o
console.log('üöÄ Sistema de Gerenciamento de Imagens carregado!');
console.log('üí° Use ImageManager.changeSectionImage("hero", "alternative", 0) para trocar imagens');
console.log('üí° Use ImageManager.listAvailableSections() para ver op√ß√µes dispon√≠veis');

// Carregar imagens personalizadas automaticamente quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        console.log('üîÑ Carregando imagens personalizadas automaticamente...');
        loadCustomImages();
    }, 1000);
});
